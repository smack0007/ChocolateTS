<Project DefaultTargets="Build">    
    <UsingTask
        TaskName="ChocolateTS.Build.Tasks.ResolveHtmlImports"
        AssemblyFile="$(MSBuildThisFileDirectory)/ChocolateTS.Build.Tasks.dll" />
    
    <PropertyGroup>
        <NewLine>%0A%0D</NewLine>
        
        <Verbosity Condition="$(Verbosity) == ''">n</Verbosity>
        <VerbosityArgs>-v:$(Verbosity) -p:Verbosity=$(Verbosity)</VerbosityArgs>

        <!-- OutputType currently supports 'Web', 'Nwjs' -->
        <OutputType Condition="$(OutputType) == ''">Web</OutputType>
        
        <SourceDirectory Condition="$(SourceDirectory) == ''">./src/</SourceDirectory>
        <OutputDirectory Condition="$(OutputDirectory) == ''">./bin/</OutputDirectory>
        <OutputFileNameWithoutExtension Condition="$(OutputFileNameWithoutExtension) == ''">$(MSBuildProjectName)</OutputFileNameWithoutExtension>

        <TsCompilerFlags>-t ES2015 -m AMD --forceConsistentCasingInFileNames --strict --incremental --sourceMap --removeComments</TsCompilerFlags>
        <TsMainPath Condition="$(TsMainPath) == ''">main.ts</TsMainPath>
        
        <ScssCompilerFlags>--output-style compressed</ScssCompilerFlags>
        <ScssMainPath Condition="$(ScssMainPath) == ''">main.scss</ScssMainPath>

        <HtmlMainPath>main.html</HtmlMainPath>

        <!-- Nwjs -->
        <NwjsRootDirectory Condition="$(NwjsRootDirectory) == ''">$(MSBuildProjectDirectory)ext/nwjs/</NwjsRootDirectory>
        <NwjsManifestPath Condition="$(NwjsManifestPath) == ''">nwjs.json</NwjsManifestPath>
    </PropertyGroup>
    
    <Target Name="DebugInfo">
        <Message Text="MSBuildToolsPath = $(MSBuildToolsPath)" />
        <Message Text="MSBuildProjectDirectory = $(MSBuildProjectDirectory)" />
        
        <Message Text="SourceDirectory = $(SourceDirectory)" />
        <Message Text="OutputDirectory = $(OutputDirectory)" />
        <Message Text="OutputFileNameWithoutExtension = $(OutputFileNameWithoutExtension)" />

        <Message Text="TsCompilerFlags = $(TsCompilerFlags)" />
        <Message Text="TsMainPath = $(TsMainPath)" />
        
        <Message Text="ScssCompilerFlags = $(ScssCompilerFlags)" />
        <Message Text="ScssMainPath = $(ScssMainPath)" />

        <Message Text="NwjsRootDirectory = $(NwjsRootDirectory)" />
        <Message Text="NwjsManifestPath = $(NwjsManifestPath)" />
    </Target>

    <!--
    Build
    -->

    <PropertyGroup>
        <BuildDependencies>BuildTs;BuildScss;BuildHtml</BuildDependencies>
        <BuildDependencies Condition="$(OutputType) == 'Nwjs'">CopyNwjsManifest</BuildDependencies>
    </PropertyGroup>

    <Target Name="Build" DependsOnTargets="DebugInfo;$(BuildDependencies)" />

    <Target Name="BuildTs">        
        <PropertyGroup>
            <BootstrapperTsPath>$(SourceDirectory)$(OutputFileNameWithoutExtension).ts</BootstrapperTsPath>
            <BootstraperTs><![CDATA[
/// <reference path="$(TsMainPath)" />
$([System.IO.File]::ReadAllText('$(MSBuildThisFileDirectory)ChocolateTS.ts'))
            ]]></BootstraperTs>
        </PropertyGroup>

        <WriteLinesToFile
            File="$(BootstrapperTsPath)"
            Overwrite="true"
            Lines="$(BootstraperTs)" />

        <Exec
            Command="tsc &quot;$(BootstrapperTsPath)&quot; $(TsCompilerFlags) --outFile &quot;$(OutputDirectory)$(OutputFileNameWithoutExtension).js&quot;"
            ContinueOnError="true">
            <Output TaskParameter="ExitCode" PropertyName="TscExitCode" />
        </Exec>

        <Delete Files="$(BootstrapperTsPath)" />

        <Error
            Condition="$(TscExitCode) != 0"
            Text="tsc exited with code $(TscExitCode)." />
    </Target>

    <Target Name="BuildScss">
        <PropertyGroup>
            <BootstrapperScssPath>$(SourceDirectory)$(OutputFileNameWithoutExtension).scss</BootstrapperScssPath>
        </PropertyGroup>

        <Exec
            Command="node-sass $(ScssCompilerFlags) &quot;$(SourceDirectory)$(ScssMainPath)&quot;"
            ConsoleToMSBuild="true"
            ContinueOnError="true">
            <Output TaskParameter="ConsoleOutput" PropertyName="ScssOutput" />
            <Output TaskParameter="ExitCode" PropertyName="NodeSassExitCode" />
        </Exec>

        <Error
            Condition="$(NodeSassExitCode) != 0"
            Text="node-sass exited with code $(NodeSassExitCode)." />

        <WriteLinesToFile
            File="$(OutputDirectory)$(OutputFileNameWithoutExtension).css"
            Overwrite="true"
            Lines="$(ScssOutput)" />
    </Target>

    <Target Name="BuildHtml">    
        <ResolveHtmlImports MainPath="$(HtmlMainPath)" SourceDirectory="$(SourceDirectory)">
            <Output TaskParameter="Output" PropertyName="HtmlOutput" />
        </ResolveHtmlImports>

        <PropertyGroup>
            <HtmlOutput><![CDATA[
<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="$(OutputFileNameWithoutExtension).css" />
    </head>
    <body>
        $(HtmlOutput)
        <script src="$(OutputFileNameWithoutExtension).js"></script>
    </body>
</html>
]]></HtmlOutput>
        </PropertyGroup>

        <WriteLinesToFile
            File="$(OutputDirectory)index.html"
            Overwrite="true"
            Lines="$(HtmlOutput)" />
    </Target>

    <Target Name="CopyNwjsManifest" Inputs="$(SourceDirectory)$(NwjsManifestPath)" Outputs="$(OutputDirectory)package.json">
        <Copy SourceFiles="$(SourceDirectory)$(NwjsManifestPath)" DestinationFiles="$(OutputDirectory)package.json" />
    </Target>

    <!--
    Run
    -->

    <Target Name="Run">
        <!-- TODO: Need to find a way to determine current platform. -->
        <Exec
            Condition="$(OutputType) == 'nwjs'"
            WorkingDirectory="$(MSBuildProjectDirectory)"
            Command="&quot;$(NwjsRootDirectory)win-x64/nw&quot; &quot;$(OutputDirectory)&quot;" />
    </Target>
</Project>