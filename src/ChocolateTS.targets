<Project DefaultTargets="Build">    
    <Target Name="Build" DependsOnTargets="BuildDebugInfo;BuildTs;BuildScss;BuildHtml" />

    <Target Name="BuildDebugInfo">
        <Message Text="ProjectDirectory = $(MSBuildProjectDirectory)" />
    </Target>

    <Target Name="BuildTs">
        <Message Text="TsFiles = @(TsFiles)" />
        
        <PropertyGroup>
            <BootstrapperTsPath>$(SourceDirectory)bootstrapper.ts</BootstrapperTsPath>
            <BootstraperTs><![CDATA[
/// <reference path="App.ts" />
customElements.define('myapp-app', MyApp.App);
            ]]></BootstraperTs>
        </PropertyGroup>

        <WriteLinesToFile
            File="$(BootstrapperTsPath)"
            Overwrite="true"
            Lines="$(BootstraperTs)" />

        <Exec Command="tsc &quot;$(BootstrapperTsPath)&quot; $(TsCompilerFlags) --outFile &quot;$(OutputDirectory)app.js&quot;" />

        <Delete Files="$(BootstrapperTsPath)" />
    </Target>

    <Target Name="BuildScss">
        <Message Text="ScssFiles = @(ScssFiles)" />

        <PropertyGroup>
            <BootstrapperScssPath>$(SourceDirectory)bootstrapper.scss</BootstrapperScssPath>
        </PropertyGroup>

        <WriteLinesToFile
            File="$(BootstrapperScssPath)"
            Overwrite="true"
            Lines="@(ScssFiles->'@import &quot;%(RecursiveDir)%(Filename)%(Extension)&quot;;')" />

        <Exec Command="node-sass $(ScssCompilerFlags) &quot;$(SourceDirectory)bootstrapper.scss&quot;" ConsoleToMSBuild="true">
            <Output TaskParameter="ConsoleOutput" PropertyName="ScssOutput" />
        </Exec>

        <Delete Files="$(BootstrapperScssPath)" />

        <WriteLinesToFile
            File="$(OutputDirectory)app.css"
            Overwrite="true"
            Lines="$(ScssOutput)" />
    </Target>

    <Target Name="BuildHtml">
        <Message Text="HtmlFiles = @(HtmlFiles)" />

        <ItemGroup>
            <HtmlFiles Condition="'%(HtmlFiles.Identity)' != ''">
                <TemplateId>$([System.IO.Path]::GetFileNameWithoutExtension('%(HtmlFiles.Identity)'))_Template</TemplateId>
                <FileContents>$([System.IO.File]::ReadAllText('%(HtmlFiles.Identity)'))</FileContents>
            </HtmlFiles>
        </ItemGroup>

        <PropertyGroup>
            <HtmlTemplates Condition="'%(HtmlFiles.Identity)' != ''"><![CDATA[$(HtmlTemplates)
<template id="%(HtmlFiles.TemplateId)">
    %(HtmlFiles.FileContents)
</template>
]]></HtmlTemplates>
        </PropertyGroup>

        <PropertyGroup>
            <IndexHtml><![CDATA[
<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="app.css" />
    </head>
    <body>
        $(HtmlTemplates)
        <myapp-app></myapp-app>
        <script src="app.js"></script>
    </body>
</html>
]]></IndexHtml>
        </PropertyGroup>

        <WriteLinesToFile
            File="$(OutputDirectory)index.html"
            Overwrite="true"
            Lines="$(IndexHtml)" />
    </Target>

</Project>